<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BMS â€“ Business Management System</title>

    <!-- External Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

    <!-- App Styles -->
    <link rel="stylesheet" href="css/index.css">

    <!-- PWA & Mobile -->
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/jpeg" href="logo.jpg">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="logo.jpg">
</head>

<body class="bg-gray-50 text-gray-900">

    <!-- â”€â”€ Login Screen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div id="loginScreen" class="fixed inset-0 gradient-bg flex items-center justify-center z-50">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md modal-enter">
            <div class="text-center mb-8">
                <div
                    class="w-16 h-16 bg-indigo-600 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg">
                    <i data-lucide="building-2" class="w-8 h-8 text-white"></i>
                </div>
                <h1 class="text-2xl font-bold text-gray-900">BMS</h1>
                <p class="text-gray-500 mt-1 text-sm">Business Management System</p>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Select Role</label>
                    <select id="roleSelect" class="form-input">
                        <option value="owner">Business Owner</option>
                        <option value="branch">Branch Manager</option>
                    </select>
                </div>

                <!-- Owner fields (shown by default) -->
                <div id="ownerFields">
                    <!-- Login Form -->
                    <div id="loginForm" class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Email Address</label>
                            <input type="email" id="ownerEmail" placeholder="owner@business.com" class="form-input"
                                onkeydown="if(event.key==='Enter') login()">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                            <input type="password" id="ownerPassword" placeholder="Enter your password"
                                class="form-input" onkeydown="if(event.key==='Enter') login()">
                        </div>
                        <div class="text-center pt-2">
                            <button onclick="toggleRegistration()"
                                class="text-sm text-indigo-600 hover:text-indigo-800 font-medium">
                                Create new account
                            </button>
                        </div>
                    </div>

                    <!-- Registration Form (hidden by default) -->
                    <div id="registerForm" class="hidden space-y-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Business Name</label>
                            <input type="text" id="regBusinessName" placeholder="My Business" class="form-input">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Mobile Number</label>
                            <div class="flex gap-2">
                                <select id="regCountryCode" class="form-input w-24 bg-gray-50">
                                    <option value="+254">ðŸ‡°ðŸ‡ª +254</option>
                                    <option value="+255">ðŸ‡¹ðŸ‡¿ +255</option>
                                    <option value="+256">ðŸ‡ºðŸ‡¬ +256</option>
                                    <option value="+250">ðŸ‡·ðŸ‡¼ +250</option>
                                    <option value="+1">ðŸ‡ºðŸ‡¸ +1</option>
                                    <option value="+44">ðŸ‡¬ðŸ‡§ +44</option>
                                    <option value="">Other</option>
                                </select>
                                <input type="tel" id="regPhone" placeholder="712 345 678" class="form-input flex-1">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Email Address</label>
                            <input type="email" id="regEmail" placeholder="owner@business.com" class="form-input">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                            <input type="password" id="regPassword" placeholder="Create a password" class="form-input">
                        </div>
                        <div class="text-center pt-2">
                            <button onclick="toggleRegistration()"
                                class="text-sm text-indigo-600 hover:text-indigo-800 font-medium">
                                Back to Login
                            </button>
                        </div>
                        <button onclick="register()"
                            class="w-full btn-primary justify-center py-3 text-base rounded-xl mt-4">
                            Create Account
                        </button>
                    </div>
                </div>

                <!-- Branch fields (hidden by default) -->
                <div id="branchSelector" class="hidden space-y-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Business Owner Email</label>
                        <input type="email" id="branchOwnerEmail" placeholder="owner@business.com" class="form-input">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Branch Name</label>
                        <input type="text" id="branchNameInput" placeholder="e.g. Main Branch" class="form-input">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Branch PIN</label>
                        <input type="password" id="pinInput" maxlength="6" placeholder="Enter 6-digit PIN"
                            class="form-input text-center tracking-widest text-lg"
                            onkeydown="if(event.key==='Enter') login()">
                    </div>
                </div>

                <button id="mainLoginBtn" onclick="login()"
                    class="w-full btn-primary justify-center py-3 text-base rounded-xl">
                    <i data-lucide="log-in" class="w-5 h-5"></i>
                    Access Dashboard
                </button>
            </div>
        </div>
    </div>

    <!-- â”€â”€ Main Application â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div id="app" class="hidden">
        <!-- Header -->
        <header class="bg-white border-b border-gray-100 sticky top-0 z-40 shadow-sm">
            <div class="flex items-center justify-between px-4 md:px-6 py-3.5">
                <div class="flex items-center gap-3">
                    <!-- Hamburger Menu (Mobile Only) -->
                    <button onclick="toggleSidebar()"
                        class="md:hidden p-2 -ml-2 text-gray-500 hover:bg-gray-100 rounded-lg">
                        <i data-lucide="menu" class="w-6 h-6"></i>
                    </button>

                    <div class="w-9 h-9 rounded-xl flex items-center justify-center shadow-sm overflow-hidden">
                        <img src="logo.jpg" alt="Logo" class="w-full h-full object-cover">
                    </div>
                    <div>
                        <h1 class="font-bold text-base leading-tight">BMS</h1>
                        <p id="userRole" class="text-xs text-gray-400 leading-tight">Business Owner</p>
                    </div>
                </div>

                <div class="flex items-center gap-3">
                    <div id="liveIndicator"
                        class="hidden items-center gap-2 px-3 py-1 rounded-full bg-emerald-100 text-emerald-700 text-xs font-medium flex">
                        <span class="w-2 h-2 rounded-full live-indicator inline-block"></span> Live
                    </div>

                    <button onclick="showNotifications()"
                        class="relative p-2 text-gray-500 hover:bg-gray-100 rounded-lg transition-colors">
                        <i data-lucide="bell" class="w-5 h-5"></i>
                        <span id="notifBadge"
                            class="absolute top-1.5 right-1.5 w-2 h-2 bg-red-500 rounded-full hidden"></span>
                    </button>

                    <button onclick="logout()" title="Logout"
                        class="p-2 text-gray-500 hover:bg-red-50 hover:text-red-600 rounded-lg transition-colors">
                        <i data-lucide="log-out" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>
        </header>

        <div class="flex h-[calc(100vh-57px)] relative">
            <!-- Sidebar Overlay (Mobile) -->
            <div id="sidebarOverlay" onclick="toggleSidebar()"
                class="fixed inset-0 bg-black/50 z-20 hidden md:hidden backdrop-blur-sm transition-opacity"></div>

            <!-- Sidebar -->
            <aside id="mainSidebar" class="w-64 bg-white border-r border-gray-100 flex flex-col flex-shrink-0 
                          fixed md:relative z-30 h-full transition-transform duration-300 transform 
                          -translate-x-full md:translate-x-0 shadow-2xl md:shadow-none">
                <nav class="flex-1 p-3 space-y-0.5 overflow-y-auto" id="sidebarNav">

                    <!-- Owner Navigation -->
                    <div id="ownerNav" class="hidden space-y-0.5">
                        <button onclick="switchView('overview',this)"
                            class="sidebar-item active w-full flex items-center gap-3 px-4 py-2.5 rounded-xl text-left text-sm font-medium text-indigo-600 bg-indigo-50">
                            <i data-lucide="layout-dashboard" class="w-4 h-4 flex-shrink-0"></i> Overview
                        </button>
                        <button onclick="switchView('branches',this)"
                            class="sidebar-item w-full flex items-center gap-3 px-4 py-2.5 rounded-xl text-left text-sm font-medium text-gray-700">
                            <i data-lucide="git-branch" class="w-4 h-4 flex-shrink-0"></i> Branches
                        </button>
                        <button onclick="switchView('tasks',this)"
                            class="sidebar-item w-full flex items-center gap-3 px-4 py-2.5 rounded-xl text-left text-sm font-medium text-gray-700">
                            <i data-lucide="check-square" class="w-4 h-4 flex-shrink-0"></i> Tasks & Objectives
                        </button>
                        <button onclick="switchView('analytics',this)"
                            class="sidebar-item w-full flex items-center gap-3 px-4 py-2.5 rounded-xl text-left text-sm font-medium text-gray-700">
                            <i data-lucide="bar-chart-3" class="w-4 h-4 flex-shrink-0"></i> Analytics
                        </button>
                        <button onclick="switchView('security',this)"
                            class="sidebar-item w-full flex items-center gap-3 px-4 py-2.5 rounded-xl text-left text-sm font-medium text-gray-700">
                            <i data-lucide="shield" class="w-4 h-4 flex-shrink-0"></i> Security
                        </button>
                    </div>

                    <!-- Branch Navigation -->
                    <div id="branchNav" class="hidden space-y-0.5">
                        <button onclick="switchView('dashboard',this)"
                            class="sidebar-item active w-full flex items-center gap-3 px-4 py-2.5 rounded-xl text-left text-sm font-medium text-indigo-600 bg-indigo-50">
                            <i data-lucide="home" class="w-4 h-4 flex-shrink-0"></i> Dashboard
                        </button>
                        <button onclick="switchView('sales',this)"
                            class="sidebar-item w-full flex items-center gap-3 px-4 py-2.5 rounded-xl text-left text-sm font-medium text-gray-700">
                            <i data-lucide="shopping-cart" class="w-4 h-4 flex-shrink-0"></i> Sales
                        </button>
                        <button onclick="switchView('expenses',this)"
                            class="sidebar-item w-full flex items-center gap-3 px-4 py-2.5 rounded-xl text-left text-sm font-medium text-gray-700">
                            <i data-lucide="credit-card" class="w-4 h-4 flex-shrink-0"></i> Expenses
                        </button>
                        <button onclick="switchView('inventory',this)"
                            class="sidebar-item w-full flex items-center gap-3 px-4 py-2.5 rounded-xl text-left text-sm font-medium text-gray-700">
                            <i data-lucide="package" class="w-4 h-4 flex-shrink-0"></i> Inventory
                        </button>
                        <button onclick="switchView('customers',this)"
                            class="sidebar-item w-full flex items-center gap-3 px-4 py-2.5 rounded-xl text-left text-sm font-medium text-gray-700">
                            <i data-lucide="users" class="w-4 h-4 flex-shrink-0"></i> Customers
                        </button>
                        <button onclick="switchView('tasks',this)"
                            class="sidebar-item w-full flex items-center gap-3 px-4 py-2.5 rounded-xl text-left text-sm font-medium text-gray-700">
                            <i data-lucide="list-todo" class="w-4 h-4 flex-shrink-0"></i> My Tasks
                        </button>
                        <button onclick="switchView('reports',this)"
                            class="sidebar-item w-full flex items-center gap-3 px-4 py-2.5 rounded-xl text-left text-sm font-medium text-gray-700">
                            <i data-lucide="file-text" class="w-4 h-4 flex-shrink-0"></i> Reports
                        </button>
                        <div class="pt-1 pb-0.5">
                            <p class="px-4 py-1 text-xs font-semibold text-gray-400 uppercase tracking-wider">More</p>
                        </div>
                        <button onclick="switchView('notes',this)"
                            class="sidebar-item w-full flex items-center gap-3 px-4 py-2.5 rounded-xl text-left text-sm font-medium text-gray-700">
                            <i data-lucide="edit-3" class="w-4 h-4 flex-shrink-0"></i> Notes
                        </button>
                        <button onclick="switchView('loans',this)"
                            class="sidebar-item w-full flex items-center gap-3 px-4 py-2.5 rounded-xl text-left text-sm font-medium text-gray-700">
                            <i data-lucide="banknote" class="w-4 h-4 flex-shrink-0"></i> Loans & Income
                        </button>
                    </div>
                </nav>

                <!-- User Info Footer -->
                <div class="p-3 border-t border-gray-100">
                    <div class="flex items-center gap-3 px-3 py-2 rounded-xl bg-gray-50">
                        <div class="w-8 h-8 rounded-full bg-indigo-100 flex items-center justify-center flex-shrink-0">
                            <i data-lucide="user" class="w-4 h-4 text-indigo-600"></i>
                        </div>
                        <div class="min-w-0 flex-1">
                            <p id="currentUser" class="text-sm font-semibold text-gray-900 truncate">Admin</p>
                            <p id="currentBranch" class="text-xs text-gray-400 truncate">All Branches</p>
                        </div>
                    </div>
                </div>
            </aside>

            <!-- Main Content -->
            <main class="flex-1 overflow-auto bg-gray-50 p-6" id="mainContent">
                <!-- Injected by JS -->
            </main>
        </div>
    </div>

    <!-- â”€â”€ Modal Overlay â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div id="modalOverlay"
        class="hidden fixed inset-0 bg-black bg-opacity-40 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div id="modalContent"
            class="bg-white rounded-2xl shadow-2xl max-w-lg w-full max-h-[90vh] overflow-auto modal-enter">
            <!-- Modal content injected by JS -->
        </div>
    </div>

    <!-- â”€â”€ Toast Container â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div id="toast-container"></div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <!--  JS MODULE LOAD ORDER (dependencies first)                         -->
    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->

    <!-- 1. Supabase Client -->
    <script src="js/supabase.js"></script>

    <!-- 2. Shared State -->
    <script src="js/state.js"></script>

    <!-- 3. Database Layer -->
    <script src="js/db.js"></script>

    <!-- 4. Core Utilities -->
    <script src="js/utils.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/simulation.js"></script>
    <script src="js/modals.js"></script>

    <!-- 5. Owner Modules -->
    <script src="js/owner/overview.js"></script>
    <script src="js/owner/branches.js"></script>
    <script src="js/owner/tasks.js"></script>
    <script src="js/owner/analytics.js"></script>
    <script src="js/owner/security.js"></script>

    <!-- 6. Branch Modules -->
    <script src="js/branch/dashboard.js"></script>
    <script src="js/branch/sales.js"></script>
    <script src="js/branch/expenses.js"></script>
    <script src="js/branch/inventory.js"></script>
    <script src="js/branch/customers.js"></script>
    <script src="js/branch/tasks.js"></script>
    <script src="js/branch/reports.js"></script>
    <script src="js/branch/notes.js"></script>
    <script src="js/branch/loans.js"></script>

    <!-- 7. Main App Router (last â€” depends on everything above) -->
    <script src="js/app.js"></script>

    <!-- 6. Initialize Lucide icons on page load -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            // Register Service Worker
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('sw.js')
                    .then(() => console.log('Service Worker Registered'))
                    .catch(err => console.error('Service Worker Failed', err));
            }
        });
    </script>

</body>

</html>